<!DOCTYPE html>
<html lang="ja">

<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>PDFÊ§úÁ¥¢„ÉÜ„Çπ„Éà</title>
   <style>
      * {
         box-sizing: border-box;
         margin: 0;
         padding: 0;
      }

      body {
         font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
         background: #f5f5f5;
         min-height: 100vh;
         padding: 20px;
      }

      .container {
         max-width: 900px;
         margin: 0 auto;
      }

      h1 {
         text-align: center;
         color: #333;
         margin-bottom: 30px;
      }

      .search-box {
         display: flex;
         gap: 10px;
         margin-bottom: 20px;
      }

      .search-input {
         flex: 1;
         padding: 12px 16px;
         font-size: 16px;
         border: 2px solid #ddd;
         border-radius: 8px;
         outline: none;
         transition: border-color 0.2s;
      }

      .search-input:focus {
         border-color: #007bff;
      }

      .search-btn {
         padding: 12px 24px;
         font-size: 16px;
         background: #007bff;
         color: white;
         border: none;
         border-radius: 8px;
         cursor: pointer;
         transition: background 0.2s;
      }

      .search-btn:hover {
         background: #0056b3;
      }

      .search-btn:disabled {
         background: #ccc;
         cursor: not-allowed;
      }

      .settings {
         display: flex;
         gap: 15px;
         margin-bottom: 20px;
         flex-wrap: wrap;
      }

      .settings label {
         display: flex;
         align-items: center;
         gap: 5px;
         font-size: 14px;
         color: #666;
      }

      .settings input,
      .settings select {
         padding: 6px 10px;
         border: 1px solid #ddd;
         border-radius: 4px;
         font-size: 14px;
      }

      .api-url {
         width: 100%;
         margin-bottom: 20px;
      }

      .api-url input {
         width: 100%;
         padding: 10px;
         border: 1px solid #ddd;
         border-radius: 4px;
         font-size: 14px;
      }

      .stats {
         background: #e9ecef;
         padding: 10px 15px;
         border-radius: 6px;
         margin-bottom: 20px;
         font-size: 14px;
         color: #666;
      }

      .results {
         display: flex;
         flex-direction: column;
         gap: 15px;
      }

      .result-item {
         background: white;
         padding: 20px;
         border-radius: 10px;
         box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .result-item h3 {
         color: #007bff;
         margin-bottom: 10px;
         font-size: 18px;
      }

      .result-item p {
         color: #666;
         line-height: 1.6;
         margin-bottom: 8px;
      }

      .result-item .meta {
         font-size: 12px;
         color: #999;
      }

      .highlight {
         background: #fff3cd;
         padding: 2px 4px;
         border-radius: 2px;
      }

      .error {
         background: #f8d7da;
         color: #721c24;
         padding: 15px;
         border-radius: 8px;
         margin-bottom: 20px;
      }

      .loading {
         text-align: center;
         padding: 40px;
         color: #666;
      }

      .no-results {
         text-align: center;
         padding: 40px;
         color: #999;
      }

      pre {
         background: #f8f9fa;
         padding: 15px;
         border-radius: 8px;
         overflow-x: auto;
         font-size: 12px;
         white-space: pre-wrap;
         word-wrap: break-word;
      }

      .toggle-raw {
         font-size: 12px;
         color: #007bff;
         cursor: pointer;
         margin-top: 10px;
      }
   </style>
</head>

<body>
   <div class="container">
      <h1>üìö PDFÊ§úÁ¥¢„ÉÜ„Çπ„Éà</h1>

      <div class="api-url">
         <label>API URL:</label>
         <input type="text" id="apiUrl" value="https://api.tierin.f5.si" placeholder="https://api.tierin.f5.si">
      </div>

      <div class="search-box">
         <input type="text" class="search-input" id="searchQuery" placeholder="Ê§úÁ¥¢„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ..." autofocus>
         <button class="search-btn" id="searchBtn" onclick="search()">Ê§úÁ¥¢</button>
      </div>

      <div class="settings">
         <label>
            „Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ:
            <input type="text" id="indexName" value="ebooks" style="width: 100px;">
         </label>
         <label>
            ‰ª∂Êï∞:
            <select id="limit">
               <option value="10">10</option>
               <option value="20" selected>20</option>
               <option value="50">50</option>
               <option value="100">100</option>
            </select>
         </label>
         <label>
            „Ç™„Éï„Çª„ÉÉ„Éà:
            <input type="number" id="offset" value="0" style="width: 60px;" min="0">
         </label>
      </div>

      <div id="stats" class="stats" style="display: none;"></div>
      <div id="error" class="error" style="display: none;"></div>
      <div id="results" class="results"></div>
   </div>

   <script>
      // Enter „Ç≠„Éº„ÅßÊ§úÁ¥¢
      document.getElementById('searchQuery').addEventListener('keypress', (e) => {
         if (e.key === 'Enter') search();
      });

      // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„Å´„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ‰∏ÄË¶ß„ÇíÂèñÂæó
      window.addEventListener('load', () => {
         fetchIndexes();
      });

      async function fetchIndexes() {
         const apiUrl = document.getElementById('apiUrl').value;
         try {
            const res = await fetch(`${apiUrl}/indexes`);
            const data = await res.json();
            if (data.indexes && data.indexes.length > 0) {
               document.getElementById('indexName').value = data.indexes[0].uid;
            }
         } catch (e) {
            console.log('„Ç§„É≥„Éá„ÉÉ„ÇØ„ÇπÂèñÂæóÂ§±Êïó:', e);
         }
      }

      async function search() {
         const query = document.getElementById('searchQuery').value;
         const apiUrl = document.getElementById('apiUrl').value;
         const indexName = document.getElementById('indexName').value;
         const limit = document.getElementById('limit').value;
         const offset = document.getElementById('offset').value;

         const resultsDiv = document.getElementById('results');
         const statsDiv = document.getElementById('stats');
         const errorDiv = document.getElementById('error');
         const searchBtn = document.getElementById('searchBtn');

         // „É™„Çª„ÉÉ„Éà
         errorDiv.style.display = 'none';
         statsDiv.style.display = 'none';
         resultsDiv.innerHTML = '<div class="loading">Ê§úÁ¥¢‰∏≠...</div>';
         searchBtn.disabled = true;

         try {
            const startTime = performance.now();
            const url = `${apiUrl}/search?q=${encodeURIComponent(query)}&index=${indexName}&limit=${limit}&offset=${offset}`;
            const res = await fetch(url);

            const endTime = performance.now();

            if (!res.ok) {
               throw new Error(`HTTP ${res.status}: ${res.statusText}`);
            }

            // JSON„ÇíÂÆâÂÖ®„Å´„Éë„Éº„Çπ
            const text = await res.text();
            let data;
            try {
               data = JSON.parse(text);
            } catch (parseError) {
               console.error('JSON Parse Error:', parseError);
               console.error('Response length:', text.length);
               console.error('Response preview:', text.substring(0, 500));
               console.error('Response end:', text.substring(text.length - 100));
               throw new Error(`JSON„Éë„Éº„Çπ„Ç®„É©„Éº: ${parseError.message}`);
            }

            // Áµ±Ë®àÊÉÖÂ†±
            statsDiv.innerHTML = `
                    Ê§úÁ¥¢ÁµêÊûú: <strong>${data.estimatedTotalHits || data.hits?.length || 0}</strong> ‰ª∂
                    | Âá¶ÁêÜÊôÇÈñì: <strong>${data.processingTimeMs || Math.round(endTime - startTime)}ms</strong>
                    | „ÇØ„Ç®„É™: "${query}"
                `;
            statsDiv.style.display = 'block';

            // ÁµêÊûúË°®Á§∫
            if (!data.hits || data.hits.length === 0) {
               resultsDiv.innerHTML = '<div class="no-results">Ê§úÁ¥¢ÁµêÊûú„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
               return;
            }

            resultsDiv.innerHTML = data.hits.map((hit, i) => {
               // „Çø„Ç§„Éà„É´„ÇíÊé¢„ÅôÔºàÊßò„ÄÖ„Å™„Éï„Ç£„Éº„É´„ÉâÂêç„Å´ÂØæÂøúÔºâ
               const title = hit.title || hit.name || hit.filename || hit.path || `ÁµêÊûú ${i + 1}`;

               // Ë™¨Êòé/ÂÜÖÂÆπ„ÇíÊé¢„Åô
               const content = hit.content || hit.text || hit.description || hit.body || '';
               const snippet = content.length > 300 ? content.substring(0, 300) + '...' : content;

               // „Åù„ÅÆ‰ªñ„ÅÆ„É°„Çø„Éá„Éº„Çø
               const meta = [];
               if (hit.author) meta.push(`ËëóËÄÖ: ${hit.author}`);
               if (hit.page) meta.push(`„Éö„Éº„Ç∏: ${hit.page}`);
               if (hit.size) meta.push(`„Çµ„Ç§„Ç∫: ${formatSize(hit.size)}`);
               if (hit.created_at || hit.createdAt) meta.push(`‰ΩúÊàêÊó•: ${hit.created_at || hit.createdAt}`);

               return `
                        <div class="result-item">
                            <h3>${escapeHtml(title)}</h3>
                            ${snippet ? `<p>${escapeHtml(snippet)}</p>` : ''}
                            ${meta.length > 0 ? `<p class="meta">${meta.join(' | ')}</p>` : ''}
                            <span class="toggle-raw" onclick="toggleRaw(this)">‚ñ∂ Áîü„Éá„Éº„Çø„ÇíË°®Á§∫</span>
                            <pre style="display: none;">${escapeHtml(JSON.stringify(hit, null, 2))}</pre>
                        </div>
                    `;
            }).join('');

         } catch (e) {
            errorDiv.textContent = `„Ç®„É©„Éº: ${e.message}`;
            errorDiv.style.display = 'block';
            resultsDiv.innerHTML = '';
         } finally {
            searchBtn.disabled = false;
         }
      }

      function toggleRaw(el) {
         const pre = el.nextElementSibling;
         if (pre.style.display === 'none') {
            pre.style.display = 'block';
            el.textContent = '‚ñº Áîü„Éá„Éº„Çø„ÇíÈö†„Åô';
         } else {
            pre.style.display = 'none';
            el.textContent = '‚ñ∂ Áîü„Éá„Éº„Çø„ÇíË°®Á§∫';
         }
      }

      function escapeHtml(text) {
         const div = document.createElement('div');
         div.textContent = text;
         return div.innerHTML;
      }

      function formatSize(bytes) {
         if (bytes < 1024) return bytes + ' B';
         if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
         return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
      }
   </script>
</body>

</html>